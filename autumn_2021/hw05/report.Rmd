---
title: "Домашняя работа №5, Плеханов Антон"
output:
  html_document:
    df_print: paged
---

## Пример оценки максимального правдоподобия для выборки из распределения Пуассона с параметром lambda = 6.

```{r}
X <- rpois(n = 200, lambda = 6)
hist(X, freq = FALSE, main = "Гистограмма выборки из Pois(6)", ylab = "Вероятность", xlab = "Значение случайной величины")
lines(dpois(1:20, lambda = 6), col = "red")
legend(x = "topright", legend = c("теоретическая плотность Pois(6)"), col = "red", fill = "red", cex = 0.7)
```

Оценим параметр lambda с помощью метода максимального правдоподобия:
```{r}
pois_neg_log_likelyhood <- function(lambda) {
  n <- length(X)
  return(n * lambda - log(lambda) * sum(X) + sum(log((sapply(X, factorial)))))
}

stats4::mle(pois_neg_log_likelyhood, method = "BFGS", start = 1)
```

Результат: MLE достаточна близка к реальному значению параметра lambda.


## Анализ малых и средних выборок из нормального распределения с помощью графикой эмпирический функций распределения, квантилей, метода огибающих

Генерируем по две выборки из нормального распределения малого и умеренного объема:
```{r}
set.seed(111)
small_sample1 <- rnorm(100, mean = 12, sd = 10)

set.seed(111)
mid_sample1 <- rnorm(1000, mean = 12, sd = 10)
```

Функция norm_empiric_theor_df_plot рисует графики эмпирической функции распределения и теоретической функции нормального распределения с параметрами mean, sd:
```{r}
norm_empiric_theor_df_plot <- function(X, mean, sd, main = "") {
  X <- sort(X)
  
  plot(X, pnorm(X, mean = mean, sd = sd), col = "red", type = "l",
       xlab = "x", ylab = "Вероятность", lwd = 4,
       main = c("Эмпирическая и теоретическая ф.р.", main))
  plot(ecdf(X), add = TRUE)
  legend(x = "topleft", col = c("red", "black"), fill = c("red", "black"),
         legend = c("Теоретическая ф.р.", "Эмпирическая ф.р."))

}

norm_empiric_theor_df_plot(small_sample1, 
                           mean = 12, sd = 10,
                           main = "small_sample1")

norm_empiric_theor_df_plot(mid_sample1, 
                           mean = 12, sd = 10,
                           main = "mid_sample1")
```

Функция рисования квантиль-квантильного графика для выборок из нормального распределения
```{r}
qq_norm_plot <- function(X) {
  # стандартизируем выборку
  z <- (X - mean(X)) / sd(X)
  
  # рисуем график
  qqnorm(z, main = "Квантиль-квантильный график",
         xlab = "Квантили стандартного нормального распределения",
         ylab = "Z-статистика выборки")
  
  # добавляем биссектрису
  # (т.е. как должен в идеале выглядеть график Z-статистики)
  lines(c(min(z) - 1, max(z) + 1), c(min(z) - 1, max(z) + 1), col = "red")
}

qq_norm_plot(small_sample1)
qq_norm_plot(mid_sample1)
```


Анализ выборки методом огибающих.
Суть метода: пусть у нас есть некоторая выборка и предположение о том, из какого она распределения. С помощью bootstrap процедуры можем сгенерировать R-ое количество выборок из предполагаемоего распределения, а затем отобразить исходную выборку и bootstrap-выборки на квантиль-квантильном графике. Для bootstrap-выборок можем задать "доверительный интервал" - область, в которой с определенной уверенностью находится выборка из предполагаемого распрделения. Если исходная выборка попадает туда, то гипотезу о принадлежности выборке этому распределению можно считать выполненной, иначе - нет.

Сгенерируем 1000 подвыборок из выборки small_sample1 методом bootstrap:
```{r}
library(boot)

# хотим проверить, является ли выборка нормально распределенной
x <- small_sample1

# стандартизируем выборку
# Если x из нормального распределения, то z ~ N(0, 1)
z <- sort((x - mean(x)) / sd(x))

# Методом bootstrap генерируем R выборок из N(0, 1)
# одновременно сортируем каждую выборку для отображения на графике
z_boot <- boot(z, sort, R = 1000, sim = "parametric", 
               ran.gen = function(data, mle) rnorm(length(data)))
```

Нарисуем квантиль-квантильные графики для всех подвыборок, чтобы воспользоваться методом огибающих:
```{r}
z_qq <- qqnorm(z, main = "Квантиль-квантильный график")
empty <- sapply(1:1000, function(i) lines(qqnorm(z_boot$t[i, ], plot.it = FALSE), col = "grey"))
points(z_qq$x, z_qq$y, pch = 20)
lines(c(min(z) - 1, max(z) + 1), c(min(z) - 1, max(z) + 1), col = "red")

z.env <- envelope(z_boot, level = 0.9)
lines(z_qq$x, z.env$point[1, ], lty = 4, col = "forestgreen")
lines(z_qq$x, z.env$point[2, ], lty = 4, col = "forestgreen")
lines(z_qq$x, z.env$overall[1, ], lty = 1)
lines(z_qq$x, z.env$overall[2, ], lty = 1)
```


## Проверка гипотез о нормальности
Критерий Смирнова-Колмогорова
Реализация ks.test() в R позволяет проверять следующие гипотезы:
1) выборка х из распределения y (Нулевая гипотеза - х не из у)
2) выборка х и выборка y из одного распределения (нулевая гипотеза - х и у не из одного распределения)
```{r}
X <- small_sample1
ks.test(X, "pnorm", 12, 10, alternative = "two.sided")
```
p-value > 0.05, => принимается альтернативная гипотеза о том, что выборка из стандартного нормального распределения.


Тест Шапиро-Уилка:
```{r}
X <- small_sample1
shapiro.test(X)
```

Тест Андерсона-Дарлинга:
```{r}
library(nortest)
X <- small_sample1
ad.test(X)
```

Тест Крамера фон Мизеса:
```{r}
X <- small_sample1
cvm.test(X)
```

Тест Колмогорова-Смирнова в модификации Лиллиефорса
```{r}
X <- small_sample1
lillie.test(X)
```

Тест Колмогорова-Смирнова в модификации Шапиро-Франсия
```{r}
X <- small_sample1
sf.test(X)
```

Все тесты не противоречат гипотезе о нормальности выборки small_sample1.


## Анализ датасета с помощью вышеупомянутых методов

```{r, message=FALSE, warning=FALSE, }
data <- read.csv("C:\\Users\\antpl_0n4duwv\\Documents\\Studies\\prac\\moscow_apartment_listings.csv")

# в качестве выборки возьмем признак footage
X <- data$footage

set.seed(1234)
X <- sample(X)

# гистограмма распрделения X
hist(X, freq = FALSE)
```

ЦПТ гласит, что центрированная и нормированная сумма н.о.р.с.в. сходится к нормальному распределению. Необходимо получить выборку из таких сумм.

Посчитаем значения среднего и дисперсии по всей выборке Х:
```{r}
X_mean <- mean(X)
X_sd <- sd(X)
```

Функия центрирования и нормирования суммы случайных величин:
```{r}
centrelize_normalize_sum <- function(Y, mean_val, sd_val) {

  n <- length(Y)
  (sum(Y) - n * mean_val) / (sd_val * sqrt(n))
}
```

Функция выделения подвыборок длины не меньше k из выборки:
```{r}
make_subsamples <- function(X, k) {
  subsamples <- list()
  index <- 1
  n <- length(X)
  while (index <= n) {
    subsamples <- append(subsamples, list(X[index : min(index + k - 1, n)]))
    index <- index + k
  }
  return(subsamples)
}
```

Разбиваем выборку Х на подвыборки длины 200, затем применяем функцию centrelize_normalize_sum для каждой подвыборки. Таким образом, получим выборку из распределения, стремящегося к нормальному, согласно ЦПТ.
```{r}
subsamples <- make_subsamples(X, 200)

Y <- mapply(centrelize_normalize_sum, subsamples, rep(X_mean, length(subsamples)), rep(X_sd, length(subsamples)))
```

Получили следущее распределение:
```{r}
hist(Y, freq = FALSE, breaks = 10)
```

Исходя из гистограммы, можно сделать вывод, что данные можно моделировать с помощью нормального распределения.

Для нормального распределения известны теоретические оценки максимального правдоподобия - выборочные мат.ожидание и дисперсия.

Проверим нормальность распределения с помощью шести критериев нормальности.

Критерий Смирнова-Колмогорова
```{r}
ks.test(Y, "pnorm", mean(Y), sd(Y), alternative = "two.sided")
```

p-value > 0.05, => принимается альтернативная гипотеза о том, что выборка из стандартного нормального распределения c параметрами mean(Y), sd(Y).


Тест Шапиро-Уилка:
```{r}
shapiro.test(Y)
```

Считаем гипотезу о нормальности выполненной.

Тест Андерсона-Дарлинга:
```{r}
ad.test(Y)
```

Гипотеза о нормальности выполнена.

Тест Крамера фон Мизеса:
```{r}
cvm.test(Y)
```

Гипотеза о нормальности выполнена.


Тест Колмогорова-Смирнова в модификации Лиллиефорса
```{r}
lillie.test(Y)
```

Гипотеза о нормальности выполнена.

Тест Шапиро-Франсия
```{r}
sf.test(Y)
```

Гипотеза о нормальности выполнена.

Стандартизируем выборку Y и проведем анализ ее распределения с помощью графиков эмпирической и теоретической функций распределений, а также квантиль-квантильного графика (предполагаемая ф.р. - N(mean(Y), sd(Y))):
```{r}
norm_empiric_theor_df_plot(Y, mean(Y), sd(Y))
```

Графики эмпирической и теоретической функции распределения довольно близки, можно сделать вывод в пользу нормальности распределения выборки.

Для построения квантиль-квантильного графика дополнительно стандартизируем выборку:
```{r}
Z <- (Y - mean(Y)) / sd(Y)
```

Анализ выборки методом огибающих:
```{r}
# Методом bootstrap генерируем R выборок из N(0, 1)
# одновременно сортируем каждую выборку для отображения на графике
z_boot <- boot(z, sort, R = 1000, sim = "parametric", 
               ran.gen = function(data, mle) rnorm(length(data)))

z_qq <- qqnorm(z,
               main = c("Квантиль-квантильный график", "для выборки Y"), 
               xlab = "Теоретические квантили",
               ylab = "Выборочные квантили")
empty <- sapply(1:1000, function(i) lines(qqnorm(z_boot$t[i, ], plot.it = FALSE), col = "grey"))
points(z_qq$x, z_qq$y, pch = 20)
lines(c(min(z) - 1, max(z) + 1), c(min(z) - 1, max(z) + 1), col = "red")

z.env <- envelope(z_boot, level = 0.9)
lines(z_qq$x, z.env$point[1, ], lty = 4, col = "forestgreen")
lines(z_qq$x, z.env$point[2, ], lty = 4, col = "forestgreen")

legend(x = "topleft", cex = 0.8,
       legend = c("выборочные квантили", "теоретические квантили", "квантили bootstrap-выборок", "огибающие уровня 0.9"), 
       col = c("black", "red", "grey", "forestgreen"), 
       fill = c("black", "red", "grey", "forestgreen"))
```

Квантиль-квантильный график также позволяет сделать вывод о нормальной распределенности выборки Y.

## Анализ гамма-распределения со случайными параметрами

#### Выборка из смешанного гамма-распределения размера 100
```{r}
set.seed(1234)
Y <- rgamma(n = 100, 
            shape = (6 + runif(100, -1, 1)), 
            rate = 1 + 0.1 * rbinom(100, 1, 0.05))

hist(Y, breaks = 20, freq = FALSE, main = c("Гистограмма гамма-распределения", "со случайными параметрами rate и shape"))
lines(density(Y), col = "forestgreen")
legend(x = "topright", legend = c("Ядерная плотность"), 
       col = c("forestgreen"), fill = c("forestgreen"), 
       cex = 0.8)

```

Для нормального распределения известны теоретические оценки максимального правдоподобия - выборочные мат.ожидание и дисперсия.

Проверим нормальность распределения с помощью шести критериев нормальности:

Тест Смирнова-Колмогорова
```{r}
ks.test(Y, "pnorm", mean(Y), sd(Y), alternative = "two.sided")
```

p-value > 0.05, => принимается альтернативная гипотеза о том, что выборка из стандартного нормального распределения c параметрами mean(Y), sd(Y).


Тест Шапиро-Уилка:
```{r}
shapiro.test(Y)
```

p-value > 0.05, следовательно, считаем гипотезу о нормальном распределении выполненной.

Тест Андерсона-Дарлинга:
```{r}
ad.test(Y)
```

Гипотеза о нормальности выполнена.

Тест Крамера фон Мизеса:
```{r}
cvm.test(Y)
```

Гипотеза о нормальности выполнена.


Тест Колмогорова-Смирнова в модификации Лиллиефорса
```{r}
lillie.test(Y)
```

Гипотеза о нормальности выполнена.

Тест Шапиро-Франсия
```{r}
sf.test(Y)
```

Гипотеза о нормальности выполнена.

Стандартизируем выборку Y и проведем анализ ее распределения с помощью графиков эмпирической и теоретической функций распределений, а также квантиль-квантильного графика (предполагаемая ф.р. - N(mean(Y), sd(Y))):
```{r}
norm_empiric_theor_df_plot(Y, mean(Y), sd(Y))
```

Анализ распределения с помощью квантиль-квантильного графика так же говорит о том, что выборка Y из смешанного гамма-распределения, вообще говоря, с высокой вероятносью может моделироваться нормальным распределением.


Для построения квантиль-квантильного графика дополнительно стандартизируем выборку:
```{r}
Z <- (Y - mean(Y)) / sd(Y)
```

Анализ выборки методом огибающих:
```{r}
# Методом bootstrap генерируем R выборок из N(0, 1)
# одновременно сортируем каждую выборку для отображения на графике
z_boot <- boot(z, sort, R = 1000, sim = "parametric", 
               ran.gen = function(data, mle) rnorm(length(data)))

z_qq <- qqnorm(z,
               main = c("Квантиль-квантильный график", "для выборки из смешанного гамма-распределения"), 
               xlab = "Теоретические квантили",
               ylab = "Выборочные квантили")
empty <- sapply(1:1000, function(i) lines(qqnorm(z_boot$t[i, ], plot.it = FALSE), col = "grey"))
points(z_qq$x, z_qq$y, pch = 20)
lines(c(min(z) - 1, max(z) + 1), c(min(z) - 1, max(z) + 1), col = "red")

z.env <- envelope(z_boot, level = 0.9)
lines(z_qq$x, z.env$point[1, ], lty = 4, col = "forestgreen")
lines(z_qq$x, z.env$point[2, ], lty = 4, col = "forestgreen")

legend(x = "topleft", cex = 0.8,
       legend = c("выборочные квантили", "теоретические квантили", "квантили bootstrap-выборок", "огибающие уровня 0.9"), 
       col = c("black", "red", "grey", "forestgreen"), 
       fill = c("black", "red", "grey", "forestgreen"))
```



#### Выборка из смешанного гамма-распределения размера 1000

```{r}
set.seed(1234)
Y <- rgamma(n = 1000, 
            shape = (6 + runif(1000, -1, 1)), 
            rate = 1 + 0.1 * rbinom(1000, 1, 0.05))

hist(Y, breaks = 20, freq = FALSE, main = c("Гистограмма гамма-распределения", "со случайными параметрами rate и shape"))
lines(density(Y), col = "forestgreen")
legend(x = "topright", legend = c("Ядерная плотность"), 
       col = c("forestgreen"), fill = c("forestgreen"), 
       cex = 0.8)

```

Для нормального распределения известны теоретические оценки максимального правдоподобия - выборочные мат.ожидание и дисперсия.

Проверим нормальность распределения с помощью шести критериев нормальности.

Критерий Смирнова-Колмогорова
```{r}
ks.test(Y, "pnorm", mean(Y), sd(Y), alternative = "two.sided")
```

p-value < 0.05, следовательно, гипотеза о нормальности считается не выполненной.


Тест Шапиро-Уилка:
```{r}
shapiro.test(Y)
```

Гипотеза о нормальности отвергается.

Тест Андерсона-Дарлинга:
```{r}
ad.test(Y)
```

Гипотеза о нормальности отвергается.

Тест Крамера фон Мизеса:
```{r}
cvm.test(Y)
```

Гипотеза о нормальности отвергается.


Тест Колмогорова-Смирнова в модификации Лиллиефорса
```{r}
lillie.test(Y)
```

Гипотеза о нормальности отвергается.

Тест Шапиро-Франсия
```{r}
sf.test(Y)
```

Гипотеза о нормальности отвергается.

Стандартизируем выборку Y и проведем анализ ее распределения с помощью графиков эмпирической и теоретической функций распределений, а также квантиль-квантильного графика (предполагаемая ф.р. - N(mean(Y), sd(Y))):
```{r}
norm_empiric_theor_df_plot(Y, mean(Y), sd(Y))
```

Графики эмпирической и теоретической ф.р. заметно отклоняются друг от друга, график эмпирической ф.р. имеет более резкие выпуклости. Учитывая гистограмму, а также результаты тестов на нормальность, можно сделать вывод, что подобные отклонения между ф.р. для больших выборок являются значительными.


Для построения квантиль-квантильного графика дополнительно стандартизируем выборку:
```{r}
Z <- (Y - mean(Y)) / sd(Y)
```

Анализ выборки методом огибающих:
```{r}
# Методом bootstrap генерируем R выборок из N(0, 1)
# одновременно сортируем каждую выборку для отображения на графике
z_boot <- boot(z, sort, R = 1000, sim = "parametric", 
               ran.gen = function(data, mle) rnorm(length(data)))

z_qq <- qqnorm(z,
               main = c("Квантиль-квантильный график", "для выборки из смешанного гамма-распределения"), 
               xlab = "Теоретические квантили",
               ylab = "Выборочные квантили")
empty <- sapply(1:1000, function(i) lines(qqnorm(z_boot$t[i, ], plot.it = FALSE), col = "grey"))
points(z_qq$x, z_qq$y, pch = 20)
lines(c(min(z) - 1, max(z) + 1), c(min(z) - 1, max(z) + 1), col = "red")

z.env <- envelope(z_boot, level = 0.9)
lines(z_qq$x, z.env$point[1, ], lty = 4, col = "forestgreen")
lines(z_qq$x, z.env$point[2, ], lty = 4, col = "forestgreen")

legend(x = "topleft", cex = 0.8,
       legend = c("выборочные квантили", "теоретические квантили", "квантили bootstrap-выборок", "огибающие уровня 0.9"), 
       col = c("black", "red", "grey", "forestgreen"), 
       fill = c("black", "red", "grey", "forestgreen"))
```
